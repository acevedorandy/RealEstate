@model RealEstate.Persistance.Models.EnumerablesModel.PropiedadDetallesModel

@{
    ViewData["Title"] = $"Vendo {Model.PropiedadesModel.Titulo}";
}

<!-- CSS de Bootstrap y Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

<!-- JS de Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
    .chat-popup {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 300px;
        background-color: white;
        z-index: 1050;
        border: 1px solid #ccc;
        transition: all 0.3s ease-in-out;
    }

    .chat-body {
        max-height: 300px;
        overflow-y: auto;
    }
</style>

<div class="container py-4">
    <div class="row">
        <!-- Galería + Info -->
        <div class="col-md-8">
            <h3>@ViewData["Title"]</h3>
            <p><i class="bi bi-geo-alt-fill"></i> @Model.PropiedadesModel.Sector, @Model.PropiedadesModel.Ciudad</p>

            @if (Model.PropiedadFotosModel != null && Model.PropiedadFotosModel.Any())
            {
                <div id="mainCarousel" class="carousel slide mb-3" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        @for (int i = 0; i < Model.PropiedadFotosModel.Count; i++)
                        {
                            <div class="carousel-item @(i == 0 ? "active" : "")">
                                <img src="@Url.Content(Model.PropiedadFotosModel[i].Imagen)" class="d-block w-100" style="max-height: 500px; object-fit: cover;" />
                            </div>
                        }
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#mainCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#mainCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                    </button>
                </div>

                <div class="d-flex flex-wrap gap-2">
                    @for (int i = 0; i < Model.PropiedadFotosModel.Count; i++)
                    {
                        <img src="@Url.Content(Model.PropiedadFotosModel[i].Imagen)" style="height: 80px; cursor: pointer;" onclick="document.querySelector('#mainCarousel .carousel').carousel(@i)" />
                    }
                </div>
            }

            <div class="mt-4">
                <h5>Resumen</h5>
                <div class="row text-center border p-3 rounded bg-light">
                    <div class="col-6 col-md-3 mb-3">
                        <strong class="text-danger">@Model.PropiedadesModel.Codigo</strong><br />
                        <small class="text-muted">Código</small>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <i class="bi bi-house-door-fill"></i><br />
                        <strong>@Model.PropiedadesModel.TipoPropiedad</strong><br />
                        <small class="text-muted">Tipo de inmueble</small>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <i class="bi bi-geo-alt-fill"></i><br />
                        <strong>@Model.PropiedadesModel.Ciudad</strong><br />
                        <small class="text-muted">Ciudad</small>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <i class="bi bi-geo-fill"></i><br />
                        <strong>@Model.PropiedadesModel.Sector</strong><br />
                        <small class="text-muted">Sector</small>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <i class="bi bi-bed-fill"></i><br />
                        <strong>@Model.PropiedadesModel.Habitaciones</strong><br />
                        <small class="text-muted">Habitaciones</small>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <i class="bi bi-badge-wc-fill"></i><br />
                        <strong>@Model.PropiedadesModel.Baños</strong><br />
                        <small class="text-muted">Baños</small>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <i class="bi bi-car-front-fill"></i><br />
                        <strong>@Model.PropiedadesModel.Parqueos</strong><br />
                        <small class="text-muted">Parqueos</small>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <i class="bi bi-building"></i><br />
                        <strong>@Model.PropiedadesModel.TotalNivel</strong><br />
                        <small class="text-muted">Total de Niveles del Edificio</small>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <i class="bi bi-arrow-bar-up"></i><br />
                        <strong>@Model.PropiedadesModel.Piso</strong><br />
                        <small class="text-muted">Piso/Nivel</small>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <i class="bi bi-aspect-ratio-fill"></i><br />
                        <strong>@Model.PropiedadesModel.TamañoTerreno</strong> Mt2<br />
                        <small class="text-muted">Construcción</small>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <i class="bi bi-calendar-event"></i><br />
                        <strong>@Model.PropiedadesModel.AñoConstruccion.ToString("yyyy")</strong><br />
                        <small class="text-muted">Año de Construcción</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info del agente y formulario -->
        <div class="col-md-4">
            <div class="card shadow-sm mb-3">
                <div class="card-body text-center">
                    <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="rounded-circle mb-2" style="width: 80px;" />
                    <h5>@Model.UsuariosModel.Nombre @Model.UsuariosModel.Apellido</h5>
                    <p class="mb-1"><i class="bi bi-telephone"></i> @Model.UsuariosModel.Telefono</p>
                    <p><i class="bi bi-envelope"></i> @Model.UsuariosModel.Email</p>
                    <div class="d-flex justify-content-center gap-2 mt-2">
                        <a href="https://wa.me/Model.UsuariosModel.Celular" target="_blank" class="btn btn-outline-success btn-sm"><i class="bi bi-whatsapp"></i></a>
                        <a href="#" class="btn btn-outline-primary btn-sm"><i class="bi bi-facebook"></i></a>
                        <a href="mailto:Model.UsuariosModel.Correo" class="btn btn-outline-dark btn-sm"><i class="bi bi-envelope-fill"></i></a>
                    </div>
                </div>
            </div>

            <!-- Sección de Chat -->
            <form id="formIniciarChat" method="post" action="/Mensajes/Create">
                <input type="hidden" name="AgenteID" value="@Model.PropiedadesModel.AgenteID" />
                <input type="hidden" name="PropiedadID" value="@Model.PropiedadesModel.PropiedadID" />
                <button type="submit" class="btn btn-outline-info btn-sm">
                    <i class="bi bi-chat-dots"></i> Iniciar chat
                </button>
            </form>

        </div>
    </div>
</div>

<!-- Mini Ventana de Chat flotante -->
<div id="chatMiniWindow" class="chat-popup shadow-lg rounded d-none">
    <div class="chat-header bg-primary text-white d-flex justify-content-between align-items-center px-3 py-2">
        <span>Chat con el agente</span>
        <button class="btn-close btn-close-white btn-sm" onclick="cerrarChat()"></button>
    </div>

    <div class="chat-body p-3">
        <form asp-controller="Mensajes" asp-action="Create" method="post">
            <p class="text-muted">¡Hola! ¿En qué puedo ayudarte con esta propiedad?</p>
            <textarea class="form-control mb-2" name="Mensaje" placeholder="Escribe tu mensaje..."></textarea>

            <input type="hidden" name="DestinatarioID" value="@Model.PropiedadesModel.AgenteID" />
            <input type="hidden" name="PropiedadID" value="@Model.PropiedadesModel.PropiedadID" />

            <button type="submit" class="btn btn-primary btn-sm w-100">Enviar</button>
        </form>
    </div>
</div>



<script>
    function abrirChat() {
        document.getElementById('chatMiniWindow').classList.remove('d-none');
    }

    function cerrarChat() {
        document.getElementById('chatMiniWindow').classList.add('d-none');
    }

    document.addEventListener('DOMContentLoaded', () => {
        const chatForm = document.getElementById('formIniciarChat');
        if (chatForm) {
            chatForm.addEventListener('submit', function (e) {
                e.preventDefault();
                abrirChat();
            });
        }
    });
</script>
